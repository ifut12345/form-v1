<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Form Presentasi â€” Preview</title>
<style>
  :root{
    --primary: #4a90e2;
    --bg1: #f3f9ff;
    --bg2: #e6f2ff;
    --card-bg: #ffffff;
    --muted:#6c7a89;
    --maxw:420px;
    --radius:14px;
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased;}
  .stage{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box}
  .wrap{width:100%;max-width:980px;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}
  .center-card{width:100%;max-width:var(--maxw);background:var(--card-bg);border-radius:var(--radius);box-shadow:0 10px 30px rgba(20,40,80,0.06);padding:22px;text-align:center;box-sizing:border-box;}
  .logo{display:flex;align-items:center;justify-content:center;margin-bottom:8px;}
  .logo img{width:96px;height:auto;border-radius:8px;object-fit:contain;}
  h1{font-size:18px;margin:6px 0 12px;color:#17324a;}
  p.lead{margin:0 0 14px;color:var(--muted);font-size:13px;}
  form{display:flex;flex-direction:column;gap:10px;align-items:center;}
  input[type=text], input[type=tel]{width:100%;padding:11px 12px;border-radius:10px;border:1px solid #e9eef6;font-size:14px;box-sizing:border-box;}
  .row{display:flex;gap:8px;width:100%;}
  button.primary{width:100%;padding:11px;border-radius:10px;border:0;background:var(--primary);color:white;font-weight:600;cursor:pointer;}
  button.secondary{width:100%;padding:11px;border-radius:10px;border:1px solid rgba(20,30,60,0.06);background:white;color:#223;cursor:pointer;}
  .small{font-size:12px;color:var(--muted);margin-top:8px;}
  /* popup */
  .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,10,20,0.45);z-index:60;}
  .modal{background:var(--card-bg);padding:18px;border-radius:12px;min-width:px;max-width:92%;box-shadow:0 12px 40px rgba(10,20,40,0.3);transform:scale(0.95) translateY(10px);opacity:0;transition:all 300ms cubic-bezier(0.32, 0.72, 0, 1);width:auto;}
  .modal.login-modal{width:320px;padding:24px;}
  .modal.dash-modal{width:min(95vw,1200px);max-height:92vh;overflow:auto;}
  .backdrop.show{display:flex;}
  .backdrop.show .modal{transform:scale(1);opacity:1;}
  .choices{display:flex;gap:8px;margin-top:12px;justify-content:center;}
  .choices button{flex:1;padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:600;}
  .yes{background:#2fb26f;color:white;}
  .no{background:#ff6b6b;color:white;}
  /* admin login btn small */
  .admin-btn{margin-top:8px;background:#fff;border:1px solid rgba(20,30,60,0.06);padding:8px 10px;border-radius:8px;cursor:pointer;}
  /* responsive */
  @media (max-width:420px){:root{--maxw:360px;} .center-card{padding:16px} input[type=text], input[type=tel]{font-size:15px}}
  /* dashboard styles */
  .dash-wrap{width:98vw;max-width:1200px;height:86vh;overflow:auto;background:var(--card-bg);border-radius:12px;padding:20px;box-sizing:border-box}
  @media (max-width:768px){.dash-grid{grid-template-columns:1fr !important}}
  .dash-grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(20,30,70,0.04);}
  .table-wrap{max-height:44vh;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #eef4fb;text-align:left}
  .tools{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .upload-input{display:block;margin-top:6px}
  .small-muted{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="stage">
    <div class="wrap">
      <div class="center-card" id="mainCard">
        <div class="logo"><img id="logoImg" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='120' height='120' rx='14' fill='%23013770' /></svg>" alt="logo"></div>
        <h1 id="presentTitle">SMA Katolik St. Louis 2</h1>
        <p class="lead" id="presentSub"></p>

        <form id="formSiswa" onsubmit="return false;">
          <input type="text" id="nama" placeholder="Nama" autocomplete="name" required />
          <input type="tel" id="telepon" placeholder="Nomor Telepon" inputmode="tel" required />
          <input type="text" id="asalSMP" placeholder="Asal SMP" required />
          <button class="primary" id="btnContinue" type="button">Lanjutkan</button>
          <button class="secondary admin-btn" id="btnAdmin" type="button">Admin</button>
          <div class="small">Data akan tersimpan walaupun halaman direfresh.</div>
        </form>
      </div>
    </div>
  </div>

  <!-- student modal -->
  <div class="backdrop" id="studentBackdrop" aria-hidden="true">
    <div class="modal login-modal" role="dialog" aria-modal="true">
      <div style="text-align:center">
        <h3 style="margin:0 0 6px 0">Terima kasih!</h3>
        <p style="margin:0;color:var(--muted)">Apakah kamu tertarik?</p>
        <div class="choices">
          <button class="yes" id="btnYes">Puas</button>
          <button class="no" id="btnNo">Tidak Puas</button>
        </div>
      </div>
    </div>
  </div>

  <!-- admin modal (login then dashboard) -->
  <div class="backdrop" id="adminBackdrop" aria-hidden="true">
    <div class="modal dash-modal" role="dialog" aria-modal="true">
      <div id="adminContent"></div>
    </div>
  </div>

<script>
// keys
const KEY_ENTRIES = 'peppo_entries_v2';
const KEY_SETTINGS = 'peppo_settings_v2';

// load settings or default
let settings = JSON.parse(localStorage.getItem(KEY_SETTINGS) || '{}');
// Set permanent defaults
settings.present = 'SMA Katolik St. Louis 2';
settings.sub = '';
if(!settings.logo) settings.logo = document.getElementById('logoImg').src;
if(!settings.bg) settings.bg = '';

function applySettings(){
  document.getElementById('presentTitle').textContent = settings.present || 'Presentasi .......';
  document.getElementById('presentSub').textContent = settings.sub || '';
  if(settings.logo) document.getElementById('logoImg').src = settings.logo;
  if(settings.bg){
    document.body.style.background = "url('"+settings.bg+"') center/cover fixed, linear-gradient(180deg,var(--bg1),var(--bg2))";
  } else {
    document.body.style.background = "linear-gradient(180deg,var(--bg1),var(--bg2))";
  }
}
applySettings();

// entries helpers
function getEntries(){ return JSON.parse(localStorage.getItem(KEY_ENTRIES) || '[]'); }
function saveEntries(arr){ localStorage.setItem(KEY_ENTRIES, JSON.stringify(arr)); }

// form behavior
const btnContinue = document.getElementById('btnContinue');
const studentBackdrop = document.getElementById('studentBackdrop');
const adminBackdrop = document.getElementById('adminBackdrop');
const form = document.getElementById('formSiswa');
btnContinue.addEventListener('click', ()=>{
  const nama = document.getElementById('nama').value.trim();
  const telepon = document.getElementById('telepon').value.trim();
  const asalSMP = document.getElementById('asalSMP').value.trim();
  if(!nama || !telepon || !asalSMP){ alert('Harap lengkapi semua data'); return; }
  // create entry but status empty until choice
  const entries = getEntries();
  const id = entries.length ? (entries[entries.length-1].id + 1) : 1;
  const entry = { id, name: nama, phone: telepon, smp: asalSMP, created: new Date().toISOString(), device: navigator.userAgent, status: null };
  entries.push(entry);
  saveEntries(entries);
  // show popup
  studentBackdrop.classList.add('show');
});

// choice handlers with immediate reset and save
document.getElementById('btnYes').addEventListener('click', ()=> handleChoice('Puas'));
document.getElementById('btnNo').addEventListener('click', ()=> handleChoice('Tidak Puas'));

function handleChoice(status){
  // find last entry with null status
  const entries = getEntries();
  for(let i=entries.length-1;i>=0;i--){
    if(entries[i].status === null){ 
      entries[i].status = status;
      entries[i].smp = document.getElementById('asalSMP').value.trim();
      break; 
    }
  }
  saveEntries(entries);
  // close modal and reset form immediately without extra confirm
  studentBackdrop.classList.remove('show');
  form.reset();
  // keep temporary values cleared from localStorage for form fields
  localStorage.removeItem('temp_name');
  localStorage.removeItem('temp_phone');
}

// preserve field values while typing (so if accidentally refresh, fields persist)
const nameInput = document.getElementById('nama');
const phoneInput = document.getElementById('telepon');
const smpInput = document.getElementById('asalSMP');
nameInput.value = localStorage.getItem('temp_name') || '';
phoneInput.value = localStorage.getItem('temp_phone') || '';
smpInput.value = localStorage.getItem('temp_smp') || '';
nameInput.addEventListener('input', ()=> localStorage.setItem('temp_name', nameInput.value));
phoneInput.addEventListener('input', ()=> localStorage.setItem('temp_phone', phoneInput.value));
smpInput.addEventListener('input', ()=> localStorage.setItem('temp_smp', smpInput.value));

// admin button open login
document.getElementById('btnAdmin').addEventListener('click', ()=> openAdminLogin());

function openAdminLogin(){
  adminBackdrop.classList.add('show');
  const content = document.getElementById('adminContent');
  content.innerHTML = `
    <div style="text-align:center;margin-bottom:16px">
      <h3 style="margin:0">Admin Login</h3>
    </div>
    <div class="card" style="padding:16px;width:280px;margin:0 auto;border-radius:10px">
      <label style="font-size:13px;display:block;margin-bottom:6px">Password Admin</label>
      <div style="position:relative">
        <input id="adminPwd" type="password" style="width:100%;padding:10px 36px 10px 12px;border-radius:8px;border:1px solid #eef;font-size:14px;background:#f9f9f9" placeholder="Masukkan password" autofocus />
        <label style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer">
          <input type="checkbox" id="togglePwd" style="display:none">
          <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </label>
      </div>
      <div style="display:flex;gap:8px;margin-top:14px">
        <button id="doLogin" class="primary" style="flex:1;padding:10px">Masuk</button>
        <button id="cancelLogin" class="secondary" style="flex:1;padding:10px">Batal</button>
      </div>
    </div>
  `;
  document.getElementById('cancelLogin').addEventListener('click', ()=> adminBackdrop.classList.remove('show'));
  document.getElementById('doLogin').addEventListener('click', doAdminLogin);
  document.getElementById('togglePwd').addEventListener('change', function() {
    const pwdInput = document.getElementById('adminPwd');
    pwdInput.type = this.checked ? 'text' : 'password';
    document.getElementById('eyeIcon').style.stroke = this.checked ? '#4a90e2' : 'currentColor';
  });
}

function doAdminLogin(){
  const v = document.getElementById('adminPwd').value || '';
  if(v === 'tidar119'){
    renderDashboard();
  } else {
    alert('Password salah');
  }
}

// dashboard render
function renderDashboard(){
  const content = document.getElementById('adminContent');
  content.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0">Dashboard Admin</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnCloseDash" style="padding:8px 10px;border-radius:8px;border:0;background:#fff;cursor:pointer">Tutup</button>
      </div>
    </div>
    <div class="dash-wrap">
      <div class="dash-grid">
        <div>
          <div class="card">
            <h4 style="margin:0 0 8px 0">Pengaturan</h4>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
              <label>Logo (unggah)</label>
              <input type="file" id="logoUpload" class="upload-input" accept="image/*" />
              <label>Background (unggah)</label>
              <input type="file" id="bgUpload" class="upload-input" accept="image/*" />
              <label>Teks Presentasi</label>
              <input type="text" id="presentInput" placeholder="Presentasi ......." value="${escapeHtml(settings.present)}" />
              <label>Sub Teks</label>
              <input type="text" id="subInput" placeholder="Sub teks" value="${escapeHtml(settings.sub)}" />
              <div style="display:flex;gap:8px">
                <button id="saveSettings" class="primary">Simpan</button>
                <button id="resetAll" class="secondary">Reset Data</button>
              </div>
            </div>
          </div>
          <div style="height:12px"></div>
          <div class="card">
            <h4 style="margin:0 0 8px 0">Rekap & Diagram</h4>
            <div style="display:flex;gap:12px;align-items:center">
              <div style="flex:1">
                <div id="chartSmall" style="height:120px;display:flex;align-items:center;justify-content:center"></div>
              </div>
              <div style="width:120px">
                <div style="font-size:13px">Puas: <strong id="countYes">0</strong></div>
                <div style="font-size:13px">Tidak Puas: <strong id="countNo">0</strong></div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <h4 style="margin:0 0 8px 0">Daftar Pengisi</h4>
            <div class="table-wrap" id="tableWrap"></div>
            <div class="tools">
              <button id="exportCSV" class="primary">Download CSV</button>
              <button id="exportPDF" class="secondary">Download PDF</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  // attach listeners
  document.getElementById('btnCloseDash').addEventListener('click', ()=> adminBackdrop.classList.remove('show'));
  document.getElementById('saveSettings').addEventListener('click', ()=>{
    settings.present = document.getElementById('presentInput').value.trim() || settings.present;
    settings.sub = document.getElementById('subInput').value.trim() || settings.sub;
    localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings));
    applySettings();
    alert('Pengaturan tersimpan');
  });
  document.getElementById('resetAll').addEventListener('click', ()=>{
    if(confirm('Reset semua data?')){ localStorage.removeItem(KEY_ENTRIES); location.reload(); }
  });
  document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
  document.getElementById('bgUpload').addEventListener('change', handleBgUpload);
  document.getElementById('exportCSV').addEventListener('click', exportCSV);
  document.getElementById('exportPDF').addEventListener('click', exportPDF);
  renderTable();
  renderChart();

  // Add single delete handler
  document.addEventListener('click', function(e) {
    if(e.target.classList.contains('deleteRow') || e.target.parentElement.classList.contains('deleteRow')) {
      const id = parseInt(e.target.dataset.id || e.target.parentElement.dataset.id);
      if(id && confirm('Hapus data ini?')) {
        const entries = getEntries().filter(e => e.id !== id);
        saveEntries(entries);
        renderTable();
        renderChart();
      }
    }
  });
}

function handleLogoUpload(e){
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=>{ settings.logo = fr.result; localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); applySettings(); alert('Logo tersimpan'); }
  fr.readAsDataURL(f);
}
function handleBgUpload(e){
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=>{ settings.bg = fr.result; localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); applySettings(); alert('Background tersimpan'); }
  fr.readAsDataURL(f);
}

function renderTable(){
  const wrap = document.getElementById('tableWrap');
  const entries = getEntries().slice().reverse();
  if(entries.length===0){ wrap.innerHTML = '<div class="small-muted">Belum ada data</div>'; return; }
  let html = `<table><thead><tr><th>No</th><th>Nama</th><th>Telp</th><th>Asal SMP</th><th>Tgl</th><th>Status</th><th style="width:30px"></th></tr></thead><tbody>`;
  entries.forEach((e,idx)=>{
    const date = new Date(e.created).toLocaleString();
    html += `<tr>
      <td>${e.id}</td>
      <td>${escapeHtml(e.name)}</td>
      <td>${escapeHtml(e.phone)}</td>
      <td>${escapeHtml(e.smp||'-')}</td>
      <td>${escapeHtml(date)}</td>
      <td>${e.status||'-'}</td>
      <td><svg class="deleteRow" data-id="${e.id}" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2" style="cursor:pointer">
        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg></td>
    </tr>`;
  });
  html += `</tbody></table>`;
  wrap.innerHTML = html;
}

function renderChart(){
  const wrap = document.getElementById('chartSmall');
  const entries = getEntries();
  const yes = entries.filter(x=>x.status==='Puas').length;
  const no = entries.filter(x=>x.status==='Tidak Puas').length;
  document.getElementById('countYes').textContent = yes;
  document.getElementById('countNo').textContent = no;
  const total = yes + no || 1;
  const pYes = Math.round((yes/total)*100);
  const pNo = 100 - pYes;
  // svg donut
  const size = 120; const r = 36; const c = size/2; const circ = 2*Math.PI*r;
  const dashYes = (yes/total)*circ; const dashNo = circ-dashYes;
  wrap.innerHTML = `
    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
      <circle cx="${c}" cy="${c}" r="${r}" fill="transparent" stroke="#f1f6ff" stroke-width="18"></circle>
      <circle cx="${c}" cy="${c}" r="${r}" fill="transparent" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#4a90e2'}" stroke-width="18"
        stroke-dasharray="${dashYes} ${dashNo}" stroke-dashoffset="${-circ*0.25}" stroke-linecap="round" transform="rotate(-90 ${c} ${c})"></circle>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="12" fill="#223">${yes}/${yes+no}</text>
    </svg>
  `;
}

// export CSV & PDF
function exportCSV(){
  const entries = getEntries();
  if(entries.length===0){ alert('Belum ada data'); return; }
  const header = ['No','Nama','Telp','Asal SMP','Tanggal','Status'];
  const rows = entries.map(e=>[e.id, e.name, e.phone, e.smp||'', new Date(e.created).toLocaleString(), e.status||'']);
  const csv = [header.join(','), ...rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='rekap_pengisi.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function exportPDF(){
  const entries = getEntries();
  const w = window.open('','_blank');
  let html = `<html><head><title>Rekap</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{padding:6px;border:1px solid #ddd}</style></head><body>`;
  html += `<h3>Rekap Pengisi</h3>`;
  html += `<table><thead><tr><th>No</th><th>Nama</th><th>Telp</th><th>Asal SMP</th><th>Tanggal</th><th>Status</th></tr></thead><tbody>`;
  getEntries().forEach(e=>{ html += `<tr><td>${e.id}</td><td>${escapeHtml(e.name)}</td><td>${escapeHtml(e.phone)}</td><td>${escapeHtml(e.smp||'')}</td><td>${new Date(e.created).toLocaleString()}</td><td>${e.status||''}</td></tr>`; });
  html += `</tbody></table></body></html>`;
  w.document.write(html); w.document.close(); setTimeout(()=> w.print(),400);
}

// small utilities
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ensure admin modal close when clicking outside or pressing ESC
studentBackdrop.addEventListener('click', (e)=>{ if(e.target === studentBackdrop) studentBackdrop.classList.remove('show'); });
adminBackdrop.addEventListener('click', (e)=>{ if(e.target === adminBackdrop) adminBackdrop.classList.remove('show'); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ studentBackdrop.classList.remove('show'); adminBackdrop.classList.remove('show'); } });

// auto-update dashboard counts if open
setInterval(()=>{ if(document.getElementById('adminContent').innerHTML.trim() !== ''){ renderTable(); renderChart(); } },1000);

// on load, restore temp input values
window.addEventListener('load', ()=>{
  const tname = localStorage.getItem('temp_name'); 
  const tphone = localStorage.getItem('temp_phone');
  const tsmp = localStorage.getItem('temp_smp');
  if(tname) document.getElementById('nama').value = tname;
  if(tphone) document.getElementById('telepon').value = tphone;
  if(tsmp) document.getElementById('asalSMP').value = tsmp;
});
</script>
</body>
</html>
